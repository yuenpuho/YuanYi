<?php
defined('BASEPATH') OR exit('No direct script access allowed');
/**
 * Class User
 */
class User extends Base_Controller {
	public function __construct() {
		parent::__construct();

        $this->load->model('rtmodel', 'RtModel', true);
	}

    /**
     * 检查是否通过微信浏览器访问的方法
     * @return bool
     */
    public function is_weixin(){
        if (strpos($_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') !== false) {
            return true;
        }

        return false;
    }

	public function index() {
        // 检查是否通过微信浏览器访问，如果是则跳转进入微信验证
        if ($this->is_weixin()) {
            header("Location: " . USERCLOUD_DNS . "wxauth_1st.php");

            exit();
        }
                
        redirect('bank/index/init');
	}
        
	public function login() {
        if ($this->is_weixin()) {
            header("Location: " . USERCLOUD_DNS . "wxauth_1st.php");

            exit();
        }

        // 统一到usercloud系统登录
        if (USERCLOUD_ACTIVE == 1) {
            redirect(USERCLOUD_URL . 'system/logout/');
        } else {
            $this->data['username'] = '';
            $this->wp_theme->view('login');
        }
	}

	public function logout() {
		$name = $this->session->userdata('user');
		$row = $this->RtModel->getUser($name);

		if (count($row)){
			$this->RtModel->addLog(array('moment' => date('Y-m-d H:i:s'), 'type' => 'logout', 'msg' => $name . ' 退出登录'));
        }

		$session_items = array('logined', 'user', 'role'); // cookie for "theme" will not delete
		foreach($session_items as $item){
			$this->session->unset_userdata($item);
        }

        $this->login();
	}
}