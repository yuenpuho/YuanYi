<?php
defined('BASEPATH') OR exit('No direct script access allowed');

class BankModel extends Base_Model {

    public function __construct() {
        parent::__construct();
    }

    public function getBanks($id = 0, $count = false) {
        $fields = '`bid`, `shortname`, `fullname`';

        // 根据银行ID 获取一条数据，主要用于修改银行信息
        if ($id) {
            $sql = "SELECT $fields FROM `bank` WHERE bid = ?";

            return $this->select($sql, $id, true);
        }

        // 计算银行总数，用于分页
        if ($count) {
            $sql = "SELECT COUNT(*) FROM `bank`";

            return $this->select($sql);
        }

        // 获取全部银行数据，主要用于操作关联贷款的公司时，给用户选择
        $sql = "SELECT $fields FROM `bank`";

        return $this->select($sql);
    }

    /**
     * 获取银行与关联的贷款公司
     * @param int $bid
     * @return array
     */
    public function getBanksWithCompanies($bid = 0) {
        $fields = 'b.bid bid, b.shortname bshort, b.fullname bfull, c.cid cid, c.fullname cfull';

        $sql = "SELECT $fields FROM `bank` b LEFT JOIN `bank_company_mapping` m ON b.bid = m.bid";
        $sql .= " LEFT JOIN `company` c ON m.cid = c.cid";

        if ($bid) {
            $sql .= " WHERE b.bid = ?";

            $result = $this->select($sql, $bid);
        } else {
            $result = $this->select($sql);
        }

        return $this->merge($result);
    }

    public function add($data) {
        return $this->insert('bank', $data);
    }

    public function edit($data, $condition) {
        return $this->update('bank', $data, $condition);
    }

    private function merge($data) {
        $temp = array();

        foreach ($data as $item) {
            $temp[$item['bid']]['bid'] = $item['bid'];
            $temp[$item['bid']]['bshort'] = $item['bshort'];
            $temp[$item['bid']]['bfull'] = $item['bfull'];

            if (isset($item['cid'])) {
                $temp[$item['bid']]['companies'][] = array('cid' => $item['cid'], 'cfull' => $item['cfull']);
            }
        }

        unset($data);

        return $temp;
    }
}